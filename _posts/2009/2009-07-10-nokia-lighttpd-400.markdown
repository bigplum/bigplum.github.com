--- 
wordpress_id: 302
layout: post
title: !binary |
  5p+Q5Lqb54mI5pys55qEbm9raWHmiYvmnLrorr/pl65saWdodHRwZOi/lOWb
  njQwMOmUmeivrw==

excerpt: "\xE8\xBF\x99\xE4\xB8\xA4\xE5\xA4\xA9\xE7\xA2\xB0\xE5\x88\xB0\xE4\xB8\x80\xE4\xB8\xAA\xE9\x97\xAE\xE9\xA2\x98\xEF\xBC\x8C\xE4\xB8\x80\xE4\xBA\x9B\xE6\x89\x8B\xE6\x9C\xBA\xE6\xB5\x8F\xE8\xA7\x88\xE6\x9F\x90\xE4\xBA\x9B\xE5\x9B\xBE\xE7\x89\x87\xE6\x97\xA0\xE6\xB3\x95\xE6\x98\xBE\xE7\xA4\xBA\xEF\xBC\x8C\xE8\x80\x8Cpc\xEF\xBC\x8C\xE5\x85\xB6\xE4\xBB\x96\xE6\x89\x8B\xE6\x9C\xBA\xE4\xB8\x8A\xE9\x83\xBD\xE8\x83\xBD\xE6\xAD\xA3\xE5\xB8\xB8\xE6\x98\xBE\xE7\xA4\xBA\xEF\xBC\x9Blighttpd\xE7\xA1\xAE\xE5\xAE\x9E\xE6\x94\xB6\xE5\x88\xB0\xE4\xBA\x86\xE8\xBF\x99\xE4\xBA\x9B\xE6\x89\x8B\xE6\x9C\xBA\xE7\x9A\x84\xE4\xB8\x8B\xE8\xBD\xBD\xE8\xAF\xB7\xE6\xB1\x82\xEF\xBC\x8C\xE4\xBD\x86\xE6\x98\xAF\xE8\xBF\x94\xE5\x9B\x9E\xE4\xBA\x86400 Bad request\xE9\x94\x99\xE8\xAF\xAF\xEF\xBC\x8C\xE9\x94\x99\xE8\xAF\xAF\xE6\x97\xA5\xE5\xBF\x97\xE4\xB9\x9F\xE6\xB2\xA1\xE6\x9C\x89\xE8\xAE\xB0\xE5\xBD\x95\xE4\xBB\x80\xE4\xB9\x88\xE5\xBC\x82\xE5\xB8\xB8\xE3\x80\x82\r\n\
  \r\n\
  \xE4\xB8\x8A\xE7\xBD\x91\xE6\x90\x9C\xE4\xBA\x86\xE5\x8D\x8A\xE5\xA4\xA9\xEF\xBC\x8C\xE6\x90\x9C\xE2\x80\x9Clighttpd wap\xE2\x80\x9D\xE6\xB2\xA1\xE6\x9C\x89\xE4\xBB\xBB\xE4\xBD\x95\xE7\xBB\x93\xE6\x9E\x9C\xEF\xBC\x8C\xE5\x8F\xAA\xE5\xA5\xBD\xE6\x8D\xA2\xE6\x88\x90\xE2\x80\x9Clighttpd mobile\xE2\x80\x9D\xEF\xBC\x8C\xE8\xBF\x99\xE4\xB8\x8B\xE7\x9C\x8B\xE5\x88\xB0\xE4\xB8\x80\xE4\xB8\xAAnokia\xE7\x9A\x84\xE5\xAD\x97\xE6\xA0\xB7\xEF\xBC\x8C\xE5\x85\xB4\xE5\xA5\x8B\xEF\xBC\x8C\xE6\x89\x93\xE5\xBC\x80\xE6\x9E\x9C\xE7\x84\xB6\xE5\x92\x8C\xE6\x88\x91\xE4\xBB\xAC\xE7\xA2\xB0\xE5\x88\xB0\xE7\x9A\x84\xE9\x97\xAE\xE9\xA2\x98\xE4\xB8\x80\xE6\xA0\xB7\xEF\xBC\x9A<a href=\"http://redmine.lighttpd.net/issues/1351\">http://redmine.lighttpd.net/issues/1351</a>.\r\n\
  \r\n\
  \xE8\xAF\xBA\xE5\x9F\xBA\xE4\xBA\x9A\xE6\x89\x8B\xE6\x9C\xBA\xE6\x9F\x90\xE4\xBA\x9B\xE5\x9E\x8B\xE5\x8F\xB7\xEF\xBC\x886680\xEF\xBC\x89\xE5\x9C\xA8\xE6\xB5\x8F\xE8\xA7\x88wap\xE9\xA1\xB5\xE9\x9D\xA2\xE6\x97\xB6\xEF\xBC\x8C\xE5\x8F\x91\xE9\x80\x81\xE7\x9A\x84header\xE5\xA6\x82\xE4\xB8\x8B\xEF\xBC\x9A\r\n\
  Accept: text/html, application/vnd.wap.xhtml+xml, application/xhtml+xml, text/css, multipart/mixed, text/vnd.wap.wml, application/vnd.wap.wmlc, application/vnd.wap.wmlscriptc, application/java-archive, application/java, application/x-java-archive, text/vnd.sun.j2me.app-descriptor, application/vnd.met.ticket, application/x-wallet-appl.user-data-provision, application/vnd.oma.drm.message, application/vnd.oma.drm.content, application/vnd.wap.mms-message, application/vnd.wap.sic, text/x-co-desc, application/vnd.oma.dd+xml, application/x-javascript, text/ecmascript, */*, text/x-vcard, text/x-vcalendar, image/gif, image/vnd.wap.wbmp\r\n\
  Accept-Charset: iso-8859-1, utf-8, iso-10646-ucs-2; q=0.6\r\n\
  Accept-Encoding: gzip,deflate,identity;q=0.9\r\n\
  Accept-Language: zh-cn, zh\r\n\
  <font color=red>Content-length: 0</font>\r\n\
  Via: WTP/1.1 GDSZ-PS-GW002-WAP03.gd.chinamobile.com (Nokia WAP Gateway 4.1 CD1/ECD13_D/4.1.04)\r\n\
  X-Forwarded-For: 10.230.30.174, 211.139.151.10\r\n\
  ......"
date: 2009-07-10 08:01:45 +08:00
wordpress_url: http://blog.59trip.com/?p=302
---
这两天碰到一个问题，一些手机浏览某些图片无法显示，而pc，其他手机上都能正常显示；lighttpd确实收到了这些手机的下载请求，但是返回了400 Bad request错误，错误日志也没有记录什么异常。

上网搜了半天，搜“lighttpd wap”没有任何结果，只好换成“lighttpd mobile”，这下看到一个nokia的字样，兴奋，打开果然和我们碰到的问题一样：<a href="http://redmine.lighttpd.net/issues/1351">http://redmine.lighttpd.net/issues/1351</a>.

诺基亚手机某些型号（6680）在浏览wap页面时，发送的header如下：
Accept: text/html, application/vnd.wap.xhtml+xml, application/xhtml+xml, text/css, multipart/mixed, text/vnd.wap.wml, application/vnd.wap.wmlc, application/vnd.wap.wmlscriptc, application/java-archive, application/java, application/x-java-archive, text/vnd.sun.j2me.app-descriptor, application/vnd.met.ticket, application/x-wallet-appl.user-data-provision, application/vnd.oma.drm.message, application/vnd.oma.drm.content, application/vnd.wap.mms-message, application/vnd.wap.sic, text/x-co-desc, application/vnd.oma.dd+xml, application/x-javascript, text/ecmascript, */*, text/x-vcard, text/x-vcalendar, image/gif, image/vnd.wap.wbmp
Accept-Charset: iso-8859-1, utf-8, iso-10646-ucs-2; q=0.6
Accept-Encoding: gzip,deflate,identity;q=0.9
Accept-Language: zh-cn, zh
<font color=red>Content-length: 0</font>
Via: WTP/1.1 GDSZ-PS-GW002-WAP03.gd.chinamobile.com (Nokia WAP Gateway 4.1 CD1/ECD13_D/4.1.04)
X-Forwarded-For: 10.230.30.174, 211.139.151.10
......
<!--more-->
关注其中Content-length这行，手机浏览器填的值为0，而其他浏览器不发送Content-length；
由于http协议规定get、head等方法不能带body，所以lighttpd就做了一下限制：
<pre class=c name=code>    case HTTP_METHOD_GET:
    case HTTP_METHOD_HEAD:
        /* content-length is forbidden for those */
        if (con->request.content_length != -1) {
		/* content-length is missing */
		if (srv->srvconf.log_request_header_on_error) {
			ERROR("GET/HEAD with content-length: %d", 400);
		}</pre>
所以nokia浏览lighttpd的页面时，会返回400错误。
修正这个问题很简单，改成下面的代码就可以了：
<pre class=c name=code>		/*if (con->request.content_length != -1) {*/
		if (con->request.content_length != -1 && con->request.content_length != 0) {</pre>
初步测试通过，firefox/ie6~8/chrome/safari/迅雷等下载都没问题。

另外，很疑惑的是，这个问题1年前就提交到lighttpd的trac中，不知道为什么一直不修改。
