--- 
wordpress_id: 272
layout: post
title: !binary |
  5Y2B5YiG6ZKf5byA5Y+R5LiA5LiqZmlyZWZveOaPkuS7tu+8iOS6jO+8iS0t
  6Ieq5Yqo55m75b2V5byA5b+D572R

excerpt: !binary |
  PGVtPu+8iGZpcmVmb3ggZXh0ZW50aW9uIOeahOS4reaWh+e/u+ivkeavlOi+
  g+a3t+S5se+8jOaMieWtl+mdouaEj+S5ieW6lOivpeS4uuaJqeWxle+8jOS9
  huWkp+WutumDveS5oOaDr+ensOS4uuaPkuS7tu+8m+iAjGZpcmVmb3jlrZjl
  nKjlj6blpJbkuIDkuKrlkI3kuLpwbHVnaW7nmoTkuJzopb/vvIzkvovlpoLv
  vIxqYXZhIHBsdWdpbuOAgWZsYXNoIHBsdWdpbu+8m+aJgOS7peWPq+aPkuS7
  tuS5n+S4jeWmpe+8m+S9huaYr++8jOS4uuS6huS+v+S6jueQhuino++8jOi/
  meezu+WIl+eahOaWh+eroOmHjOmDveaKimV4dGVudGlvbuensOS4uuaPkuS7
  tuOAgu+8iQ0KPC9lbT4NCg0KPGEgaHJlZj0iaHR0cDovL2Jsb2cuNTl0cmlw
  LmNvbS9hcmNoaXZlcy8yNDYiPuS4iuaWhzwvYT7miJHku6zku453aXphcmTk
  uIrojrflvpfkuobkuIDkuKrmj5Lku7bku6PnoIHljovnvKnljIXvvIzov5nk
  uKrljIXnmoTmianlsZXlkI3ljbPkvb/mlLnkuLp4cGnvvIzkuZ/ml6Dms5Xl
  ronoo4XliLBmaXJlZm945Lit44CC55So5Y+m5aSW5LiA56eN5a6J6KOF5pa5
  5rOV5Y+v5Lul5pCe5a6a77yM6L+Z56eN5pa55rOV5Lmf6YCC5ZCI5o+S5Lu2
  55qE5L+u5pS56LCD6K+V5L2/55So44CCDQoxLiDlsIbljovnvKnljIXop6Pl
  jovvvIzkvovlpoLvvJpDOlx3b3JrXGthaXhpbg0KMi4g5om+5YiwZmlyZWZv
  eOeahOaPkuS7tuWuieijheebruW9le+8jOS4gOiIrOS4ukM6XERvY3VtZW50
  cyBhbmQgU2V0dGluZ3NcQWRtaW5pc3RyYXRvclxBcHBsaWNhdGlvbiBEYXRh
  XE1vemlsbGFcRmlyZWZveFxQcm9maWxlc1xpMzJ1cXV1by5kZWZhdWx0XGV4
  dGVuc2lvbnMNCjMuIOWcqOivpeebruW9leS4i+W7uueri+S4gOS4quaWh+S7
  tu+8jOWRveWQjeS4uuaPkuS7tuW8gOWPkeiAheeahGVtYWls5Zyw5Z2A77yM
  5L6L5aaCOiBrYWl4aW5AMTYzLmNvbSg8c3Ryb25nPui/meS4quWQjeWtl+im
  geS4juWcqOWQkeWvvOS4reWhq+WGmeeahGVtYWls55u45ZCMPC9zdHJvbmc+
  KQ0KNC4g5bCG6L+Z5Liq5paH5Lu255qE5YaF5a655pS55Li6ICBDOlx3b3Jr
  XGthaXhpblwgICg8c3Ryb25nPuazqOaEj++8jOW/hemhu+imgeacieacgOWQ
  juS4gOS4qiJcIjwvc3Ryb25nPikNCjUuIOmHjeWQr2ZpcmVmb3jvvIzlsLHo
  g73ku44gIuW3peWFty0+6ZmE5Yqg57uE5Lu2IiDkuK3nnIvliLDmlrDlop7l
  iqDnmoTmj5Lku7bkuoY7

date: 2009-07-09 08:13:42 +08:00
wordpress_url: http://blog.59trip.com/?p=272
---
<em>（firefox extention 的中文翻译比较混乱，按字面意义应该为扩展，但大家都习惯称为插件；而firefox存在另外一个名为plugin的东西，例如，java plugin、flash plugin；所以叫插件也不妥；但是，为了便于理解，这系列的文章里都把extention称为插件。）
</em>

<a href="http://blog.59trip.com/archives/246">上文</a>我们从wizard上获得了一个插件代码压缩包，这个包的扩展名即使改为xpi，也无法安装到firefox中。用另外一种安装方法可以搞定，这种方法也适合插件的修改调试使用。
1. 将压缩包解压，例如：C:\work\kaixin
2. 找到firefox的插件安装目录，一般为C:\Documents and Settings\Administrator\Application Data\Mozilla\Firefox\Profiles\i32uquuo.default\extensions
3. 在该目录下建立一个文件，命名为插件开发者的email地址，例如: kaixin@163.com(<strong>这个名字要与在向导中填写的email相同</strong>)
4. 将这个文件的内容改为  C:\work\kaixin\  (<strong>注意，必须要有最后一个"\"</strong>)
5. 重启firefox，就能从 "工具-&gt;附加组件" 中看到新增加的插件了;
<!--more-->
我们来体验一下这个插件，单击该附件的选项按钮，<a href="http://pipablog.tk/wp-content/uploads/2009/07/kaixin_prefer.jpg"><img class="size-medium wp-image-278" title="kaixin_prefer" src="http://pipablog.tk/wp-content/uploads/2009/07/kaixin_prefer-300x289.jpg" alt="kaixin_prefer" width="300" height="289" /></a>单击菜单 “工具-&gt;You localized menuitem”, 会弹出“hello world” 对话框。<a href="http://pipablog.tk/wp-content/uploads/2009/07/kaixin_menu.jpg"><img class="size-medium wp-image-279" title="kaixin_menu" src="http://pipablog.tk/wp-content/uploads/2009/07/kaixin_menu-213x300.jpg" alt="kaixin_menu" width="213" height="300" /></a>

接着继续改造这个插件，做一个一键登录开心网的功能。从“选项”对话框中填入开心网的账号和密码，然后点击login登录到开心网。

1. 修改option对话框
使用<a href="http://blog.59trip.com/archives/246">前面</a>介绍过的extention dev插件里带的xul编辑器来编辑xul文件，很方便测试。 将C:\work\kaixin\content\options.xul，替换为下面的代码：
<pre class=xml name=code>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;?xml-stylesheet href="chrome://global/skin/" type="text/css"?&gt;
&lt;!DOCTYPE prefwindow SYSTEM "chrome://kaixin/locale/prefwindow.dtd"&gt;
&lt;!--定义按钮事件处理--&gt;
&lt;prefwindow id="kaixinPreferences"
xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
ondialogaccept="return kaixin_options.doOK();"
ondialogcancel="return kaixin_options.doCancel();"
onload="sizeToContent();kaixin_options.LoadOptions();"
title="kaixin Preferences"&gt;
&lt;!--载入javascript文件--&gt;
&lt;script type="application/x-javascript"
src="chrome://kaixin/content/options.js" /&gt;
&lt;script type="application/x-javascript"
src="chrome://kaixin/content/utils.js" /&gt;
&lt;prefpane id="pane1" label="&amp;pane1.title;"&gt;
&lt;!--定义用户名输入框--&gt;
&lt;label accesskey="U" control="textstringpref"&gt;Username&lt;/label&gt;
&lt;textbox id="gUserName" preference="stringpref1"/&gt;
&lt;!--定义密码输入框--&gt;
&lt;label accesskey="p" control="textstringpref"&gt;Password&lt;/label&gt;
&lt;textbox id="gPwd" type="password" preference="stringpref2"/&gt;
&lt;!--是否记住密码--&gt;
&lt;checkbox id="gRemember" label="Remember Password"
oncommand="kaixin_options.DisableAutoSignIn()"/&gt;
&lt;/prefpane&gt;
&lt;/prefwindow&gt;
</pre>
效果如图：<a href="http://pipablog.tk/wp-content/uploads/2009/07/kaixin_pref.jpg"><img class="size-full wp-image-285" title="kaixin_pref" src="http://pipablog.tk/wp-content/uploads/2009/07/kaixin_pref.jpg" alt="kaixin_pref" width="205" height="208" /></a>

2. 自动生成的菜单按钮不方便使用，把它修改成工具栏上的按钮
<pre class=xml name=code>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;?xml-stylesheet href="chrome://kaixin/skin/overlay.css" type="text/css"?&gt;
&lt;!DOCTYPE overlay SYSTEM "chrome://kaixin/locale/kaixin.dtd"&gt;
&lt;overlay id="kaixin-overlay"
xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"&gt;
&lt;script type="application/x-javascript"
src="chrome://kaixin/content/options.js" /&gt;
&lt;script type="application/x-javascript"
src="chrome://kaixin/content/utils.js" /&gt;
&lt;script type="application/x-javascript"
src="chrome://kaixin/content/overlay.js" /&gt;
&lt;script type="application/x-javascript"
src="chrome://kaixin/content/xmlhttpNew.js" /&gt;
&lt;stringbundleset id="stringbundleset"&gt;
&lt;stringbundle id="kaixin-strings"
src="chrome://kaixin/locale/kaixin.properties"/&gt;
&lt;/stringbundleset&gt;

&lt;menubar id="main-menubar"&gt;
&lt;menu id="kaixin-menu" label="Kaixin"
insertafter="helpMenu" accesskey="a"&gt;
&lt;menupopup id="kaixin-menupopup"&gt;
&lt;menuitem id="kaixin-login"
image="chrome://kaixin/skin/login.png" fixed="yes" hidden="false" oncommand="kaixin.doLogin(true);" label="Login" accesskey="L" /&gt;
&lt;menuitem id="kaixin-options"
image="chrome://kaixin/skin/options.png" fixed="yes" hidden="false" oncommand="kaixin.showOptions();" label="Options" accesskey="O" /&gt;
&lt;/menupopup&gt;
&lt;/menu&gt;
&lt;/menubar&gt;
&lt;/overlay&gt;
</pre>
效果如图：<a href="http://pipablog.tk/wp-content/uploads/2009/07/toolbar.jpg"><img class="size-full wp-image-289" title="toolbar" src="http://pipablog.tk/wp-content/uploads/2009/07/toolbar.jpg" alt="toolbar" width="161" height="88" /></a>

3. 实现事件处理的javascript函数，这里只捡几个重要的说明一下
保存用户名密码：
<pre class="javascript" name="code">doOK:function(){
    try{
        //获取username
        var _5=kaixin_jsUtils.trimWhitespace(document.getElementById("gUserName").value);
        var _6=document.getElementById("gPwd").value;
        //调用firefox的参数设置功能
        gbmPrefHandler.setPref(dbPrefNames.prefUserName,_5,"char");
        gbmPrefHandler.setPref(dbPrefNames.prefRememberPwd,document.getElementById("gRemember").checked,"char");
        var _7="chrome://kaixin/";
        if(document.getElementById("gRemember").checked){
            //调用firefox的密码保存功能
            kaixin_jsUtils.savePwd(_7,_5,_6);
        }else{
            kaixin_jsUtils.removePwd(_7,_5,_6);
        }
        return true;
    }
    catch(ex){
        alert(ex);
        return false;
    }</pre>
登录处理函数：
<pre class="javascript" name="code">doLogin:function(_5d){
    try{
            ...
        var _60=new kaixin_WebResponse(0,"");   //定义ajax响应
        //定义开心网的登录url
        var uri= "http://www.kaixin001.com/login/login.php";
        var _62=(gbmPrefHandler.getPref(dbPrefNames.prefRememberPwd,"char")=="true")?true:false;
        var _63=gbmPrefHandler.getPref(dbPrefNames.prefUserName,"char");
        ...
        var _64="chrome://kaixin/";
        var _65=kaixin_jsUtils.getPwd(_64,_63);    //从密码管理器获取密码
        ...
        var _6a="email="+escape(_63)+"&amp;password="+escape(_65)+"";   //构造post参数
        _60=xhttp.doSyncPost(_6a,"",uri);           //提交ajax请求
        _5f=kaixin.checkLogin();   //根据cookie检查是否登录成功
        if(!_5f){
            throw "Login failed! check your password...";
        }else{
            if(!_62){
                alert("Login successful!");
            }
            if(_5d){
                var url="http://www.kaixin001.com";
                kaixin_Handler.OpenInTab(url,true);    //登录成功，新开一个tab页面
            }
        }
        return true;
    }
    catch(ex){
        alert(ex);
        throw ex;
        return false;
    }
}</pre>
代码中用到的firefox参数处理函数，ajax处理均来自另一个插件gbookmarks，本插件的源码从<a href="http://blog.59trip.com/firefox_kaixin">这里下载</a>。后面会继续完善这个插件，做一些自动处理的功能，敬请关注。
